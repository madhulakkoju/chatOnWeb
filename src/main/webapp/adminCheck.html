<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>HELP CHAT</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<body>

<div class="flex-container" style="display:flex">

  <div  id="chatsPane" class="flex-child magenta" style="margin-right: 80px;" >
    <div class="green">
    	CHATS
    </div>
    <table id = "chats">
    <th>  
    <td>ALL CHATS</td>
    </th>
    </table>
    
  </div>
  
  <div class="flex-child green" style="flex: 1;border: 2px solid yellow;">
    <div id="singleChat" class="blue" style="overflow-y:scroll;overflow-x:hidden;height:500px">
    	CHAT
    </div>
    <form id="do-chat">
    <input type="text" name="message" id = "message">
    <input type="submit" id = "send" value= "Send">
    </form>
  </div>
</div>




<script>

var wsocket;
var serviceLocation = "ws://localhost:8080/chatOnWeb/helpChat/";
var $message;
const myUserName = "ADMIN_USER"
var currentChatUser="";
var allChatThreads = [];

$(document).ready(function () {
	   
    $message = $('#message');
    $chatWindow = $('#showChat');
    $alert = $('#alert');

    connectToChatServer();

    $('#do-chat').submit(function (evt) {
        evt.preventDefault();
        sendMessage()
    });
});

function connectToChatServer()
{
	wsocket = new WebSocket(constructURI(serviceLocation,myUserName));
	
	wsocket.onerror = onConnectionError;
    wsocket.onmessage = onMessageReceived;
    console.log("Done");
}

function onConnectionError(evt)
{
	$alert.append($(evt));
}

function onMessageReceived(evt)
{
	var message = JSON.parse(evt.data); 
	console.log(message);
	updateChatPage(message.Sender, message.MessageBody);
	scrollDown("singleChat");
}


function scrollDown(id)
{
	var objDiv = document.getElementById(id);
    objDiv.scrollTop = objDiv.scrollHeight;
}

function sendMessage()
{
	console.log("Send Message");
	
	msg = new Object();
	msg.MessageBody = document.getElementById("message").value;
	if(msg.MessageBody=="")
		return;
	msg.receiver = "ADMIN_USER";
	msg.Sender = currentChatUser;
	if(msg.Sender=="")
		return;
    document.getElementById("message").value="";
	
	//messages.push(msg);
	// send the msg object to json to server for addition of the Data to database
	
	updateChatPage(myUserName,msg.MessageBody);
	msg.receiver = msg.Sender;
	// Construct message to send to server
    var mssg = JSON.stringify(msg);
    wsocket.send(mssg);
	console.log(mssg);
    // Put back focus
    $message.val('').focus();
    scrollDown("singleChat");
    console.log("Sent Message");
}


function constructURI(serviceLocation,user)
{
	return serviceLocation+user;
}








var threads=[
	{"Sender":"madhu.ml193@gmail.com",
		"messages":[
		{"Sender":"ADMIN_USER","MessageBody":"message"},
		{"Sender":"ADMIN_USER","MessageBody":"madhu.ml193@gmail.com"},
		]},
	{"Sender":"madsdfsdfsdail.com",
		"messages":[
		{"Sender":"ADMIN_USER","MessageBody":"message"},
		{"Sender":"ADMIN_USER","MessageBody":"madsdfsdfsdail.com"},
	]},
	{"Sender":"madhugfg3@gmail.com",
		"messages":[
		{"Sender":"ADMIN_USER","MessageBody":"message"},
		{"Sender":"ADMIN_USER","MessageBody":"madhugfg3@gmail.com"},
	]},
	{"Sender":"marr.ml193@gmail.com",
		"messages":[
		{"Sender":"ADMIN_USER","MessageBody":"message"},
		{"Sender":"ADMIN_USER","MessageBody":"marr.ml193@gmail.com"},
		]},
	{"Sender":"madsdflolo93@gmail.com",
		"messages":[
		{"Sender":"ADMIN_USER","MessageBody":"message"},
		{"Sender":"ADMIN_USER","MessageBody":"madsdflolo93@gmail.com"},
		]}
];
addMessageThreads(threads);



createChats(threads);

function createChats(threads)
{
	threads.forEach(
		function generate(item,index)
		{
			allChatThreads[item["Sender"]] = chatPage(item);
		}
	);
}

function chatPage(messageThread)
{
	var table = document.createElement('table');
	table.id = messageThread["Sender"]+"_chat";
	messageThread["messages"].forEach(
		function (item,index)
		{
			var tr = document.createElement('tr');
			var td = document.createTextNode(item.Sender);
			tr.appendChild(td);
			
			var td = document.createElement('td');
			td.appendChild(document.createTextNode(":"));
			tr.appendChild(td);
			
			var td = document.createElement('td');
			td.appendChild(document.createTextNode(item.MessageBody));
			tr.appendChild(td);
			
			table.appendChild(tr);
		}
	);
	return table;
}

function addMessageThreads(threads)
{
	var chats = document.getElementById("chats");
	threads.forEach(
		function addToChats(item,index)
		{
			var div = document.createElement('div');
			div.id = item["Sender"];
			div.innerHTML = '<h4>'+item["Sender"]+'</h4>';
			div.onclick = function (){
				var div = document.getElementById('singleChat');
				div.innerHTML="";
				div.appendChild(allChatThreads[item["Sender"]]);
				currentChatUser = item.Sender;
				//console.log(currentChatUser);
			};
			var row = document.createElement('tr');
			row.append(div);
			chats.appendChild(row);
		}
	);
}

function updateChatPage(sender,message)
{
	var table = document.getElementById(currentChatUser + "_chat");
	
	var tr=document.createElement('TR');
	var td = document.createElement('TD')
	td.appendChild(document.createTextNode(sender));
	tr.appendChild(td);
	
	td = document.createElement('TD')
	td.appendChild(document.createTextNode(":"))
	tr.appendChild(td);
	
	td = document.createElement('TD')
	td.appendChild(document.createTextNode(message));
	tr.appendChild(td);
	table.appendChild(tr);
	
	
	/*
	var div = document.getElementById("singleChat");
	div.innerHTML = '';
	div.appendChild(table);
	*/
}



</script>

</body>
</html>





